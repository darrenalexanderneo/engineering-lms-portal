<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

    <!-- Bootstrap Font Icon CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">

    <link rel="stylesheet" href="../../static/css/learner.css">



    <title>Register for Classes</title>
</head>
<body style="background-color: #eee;" onload="renderCreateQuizPage()">
    <!-- navigation bar -->
    <nav class="navbar navbar-dark bg-dark">
        <div class="my-3"> </div>
        <div class="my-3 float-end">
            <button onclick="logout()" class="btn btn-outline-light me-5">Logout</button>
        </div>
    </nav>
    <br>

    <!-- back to prev page -->
    <div class="container mb-4">
        <div><svg xmlns="http://www.w3.org/2000/svg" onclick="backToPrevPage('tnr_view_quiz_list')" width="45" height="45" fill="currentColor" class="bi bi-arrow-left-circle" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8zm15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-4.5-.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5z"></path>
          </svg></div>
    </div>

    <!-- title -->
    <div class="container mb-4">
        <div id="quiz-title"></div>
        <form class="needs-validation" novalidate>
            <div class="form-group row">
                <label for="inputPassword" class="col-sm-2 col-form-label" style="font-size: 20px;">Duration: </label>
                <input type="number" class="form-control col-sm-2" id="hour" placeholder="HH" class="valid-feedback">
                <input type="number" class="form-control col-sm-2" id="minute" placeholder="MM" class="valid-feedback">
                <div class="invalid-feedback">
                    Please choose a username.
                </div>
            </div>
        </form>
    </div>

    <!-- test
    <form class="row g-3 needs-validation" novalidate>
        <div class="col-md-4">
          <label for="validationCustom01" class="form-label">First name</label>
          <input type="text" class="form-control" id="validationCustom01" value="Mark" required>
          <div class="valid-feedback">
            Looks good!
          </div>
        </div>
        <div class="col-md-4">
          <label for="validationCustom02" class="form-label">Last name</label>
          <input type="text" class="form-control" id="validationCustom02" value="Otto" required>
          <div class="valid-feedback">
            Looks good!
          </div>
        </div>
        <div class="col-md-4">
          <label for="validationCustomUsername" class="form-label">Username</label>
          <div class="input-group has-validation">
            <span class="input-group-text" id="inputGroupPrepend">@</span>
            <input type="text" class="form-control" id="validationCustomUsername" aria-describedby="inputGroupPrepend" required>
            <div class="invalid-feedback">
              Please choose a username.
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <label for="validationCustom03" class="form-label">City</label>
          <input type="text" class="form-control" id="validationCustom03" required>
          <div class="invalid-feedback">
            Please provide a valid city.
          </div>
        </div>
        <div class="col-md-3">
          <label for="validationCustom04" class="form-label">State</label>
          <select class="form-select" id="validationCustom04" required>
            <option selected disabled value="">Choose...</option>
            <option>...</option>
          </select>
          <div class="invalid-feedback">
            Please select a valid state.
          </div>
        </div>
        <div class="col-md-3">
          <label for="validationCustom05" class="form-label">Zip</label>
          <input type="text" class="form-control" id="validationCustom05" required>
          <div class="invalid-feedback">
            Please provide a valid zip.
          </div>
        </div>
        <div class="col-12">
          <div class="form-group">
            <input class="form-group-input" type="checkbox" value="" id="invalidCheck" required>
            <label class="form-group-label" for="invalidCheck">
              Agree to terms and conditions
            </label>
            <div class="invalid-feedback">
              You must agree before submitting.
            </div>
          </div>
        </div>
        <div class="col-12">
          <button class="btn btn-primary" type="submit">Submit form</button>
        </div>
      </form> -->

      <form class="row g-3 needs-validation" novalidate>
       
        <div class="col-md-4">
          <div class="input-group has-validation">
            <input type="text" class="form-control" id="validationCustomUsername" aria-describedby="inputGroupPrepend" placeholder="Enter a question" required>
            <div class="invalid-feedback">
              Please choose a username.
            </div>
          </div>
        </div>

        <div class="col-12">
          <button class="btn btn-primary" type="submit">Submit form</button>
        </div>
      </form>
    <!-- question list -->
    <form id="quiz-form" class="needs-validation" novalidate>
        <div id="qn-list">
        
        </div>

         <!-- actions -->
        <div class="container mt-4">
            <button onclick="addAQn(); updateQuizSummary();" class="btn btn-outline-primary float-right px-4 py-2" type="button" style="border-radius: 2rem;">Add a Question</button>
        </div>
       
        <div id="create-quiz-alert" class="container"></div>
    
        <div id="feedback-text" class="container">
           <div class="row">
                <div id="quiz-summary" class="col-6">
                    <p>Total Marks: </p> 
                    <p>Number of Questions: </p>
                </div>
                <div class="col-6">
                    <button onclick='createQuiz();' type="submit" class="btn btn-outline-success float-right px-4 py-2" style="border-radius: 2rem; bottom: 0;">Save & Create Quiz</button>
                </div>
           </div>
        </div>

    </form>   
    
    <br><br><br><br>



    
    

    
    
</body>
    <script src="../../static/js/main.js"></script>

    <script>
    //initialise localStorage
    const storage = window.localStorage;
    
    // variables
    const quiz_id = storage.getItem("quiz_id"); 
    const quiz_id_list = quiz_id.split("_");
    const quiz_type = storage.getItem("quiz_type"); 
    

    //
    var num_of_qns = 0; // curr qn number
    var QID = 0; // # of questions created including deleted ones
    var QID_LS = [];
    var invalid_msg = '';
    var validation = true;

    //
    var post_obj = {
        'type': `${quiz_type}`,
        'quiz_id': `${quiz_id}`,
        'question_id': [],
        'question': [], // ["How many ggghashira are there in demon slayer?","Is Rengoku a flameeeee hashira?"]
        'question_type': [], //["MCQ", "T/F"]
        'option': [], // ["11,12,13,14", "True,False"]
        'question_mark': [], // ["2","2"]
        'answer': [], // ["13", "True"]
        'total_marks': 0, // 6
        'timing': "00:00", // '50:00'
        'num_of_questions': 0 // 2
    };

    // Example starter JavaScript for disabling form submissions if there are invalid fields
    (function() {
        'use strict'
    
        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        var forms = document.querySelectorAll('.needs-validation')
        console.log('==== undergoing validation =====');
    
        // Loop over them and prevent submission
        Array.prototype.slice.call(forms)
        .forEach(function (form) {
            form.addEventListener('submit', function (event) {
            console.log('***check form validity');
            event.preventDefault()
            if (!form.checkValidity()) {
                event.stopPropagation()
            }
    
            form.classList.add('was-validated')
            }, false)
        })
    })();


    function validateFields() {
        
        let hour_valid = document.getElementById("hour").value;
        let min_valid = document.getElementById("minute").value;
        console.log(hour_valid)


    }

    function renderCreateQuizPage() {
        getAPIkeys_TNR();
    
        console.log("===== localStorage.getItem() =====")
        console.log(`quiz_id: ${quiz_id} || quiz_type: ${quiz_type}`);
    
        getTitle('quiz-title');
    }

    function getTitle(div_id) {
        document.getElementById(div_id).innerHTML = "";
        console.log(quiz_id_list, quiz_id_list[2].slice(-2, -1));
        var chap_name = quiz_type == 'chapter_quiz' ? `Chapter ${quiz_id_list[2].slice(-2, -1)} Quiz` : 'Final Quiz'; // _FinalQuizq, _Chapt3q
        
        var html_content = `
        <h2>${chap_name}</h2>
        <h4>${quiz_id_list[0]} Class ${quiz_id_list[1].slice(1)}</h4> 
        
        `;

        document.getElementById(div_id).innerHTML = html_content;
    }

    function addAQn() {

        QID += 1;
        post_obj.num_of_questions += 1;
        num_of_qns += 1;
        QID_LS.push(`q${QID}`);


        console.log("===== clicked on addAQn() =====")
        console.log(`QID: ${QID} || NUM_OF_QNS: ${num_of_qns} || ${QID_LS}`)

        html_user_selection = `
        <!-- question format -->
        <div class="form-row">
            <div class="form-group col-md-3">
                <select id="q${QID}-type" onchange="setQnType(this.id)" class="form-control" placeholder="Question Type">
                    <option value="tf-selected" selected>T/F</option>
                    <option value="mcq-selected">MCQ</option>
                </select>
            </div>
            <div id="q${QID}-mcq-num" class="form-group col-md-3 d-none">
                <input type="number" onchange="changeNumOfOptions(this.id)" id="q${QID}-mcq-num-input" min="2" max="6" class="form-control" placeholder="# of Options" value="2">
            </div>
            <div class="form-group col-md-3" style="margin-right: 0;">
                <input type="number" onchange="updateQuizSummary()" class="form-control" id="q${QID}-marks" placeholder="Marks">
            </div>
        </div>
        
        <!-- input question -->
        <div class="form-group has-validation">
            <input type="text" class="form-control" id="q${QID}-qn" placeholder="Enter your question" required>
            <div class="invalid-feedback">
                Please enter your question.
              </div>
        </div>`;

        html_option_ls = `
        <!-- options part -->
        <p>Options</p>
        <div id="q${QID}-options" class="container">
            <div class="form-group">
                <input class="form-group-input" type="radio" name="q${QID}-options" id="true" value="True" checked>
                <label class="form-group-label" for="true">True</label>
            </div>
            <div class="form-group">
                <input class="form-group-input" type="radio" name="q${QID}-options" id="false" value="False">
                <label class="form-group-label" for="false">False</label>
            </div>
        </div>`;

        html_content = `
        <!-- question -->
        <div id="q${QID}" class="container p-4 border" style="background-color: white;">
            <div class="row align-items-center mb-3">
                <div class="col-8"> <h5 id="q${QID}-title"> Question ${QID}</h5> </div>
                <div id='q${QID}-del-btn' class="col-4" onclick="delAQn(this.id);"  style="text-align: right;"> <button type="button" onclick="updateQuizSummary()" class="btn btn-outline-danger">Delete</button> </div>
            </div>

            ${html_user_selection}

            ${html_option_ls}
        </div>`;

        document.getElementById('qn-list').innerHTML += html_content;

        changeQnNumber();
    }

    /*
    <form class="row g-3 needs-validation" novalidate>
       
        <div class="col-md-4">
          <div class="input-group has-validation">
            <input type="text" class="form-control" id="validationCustomUsername" aria-describedby="inputGroupPrepend" placeholder="Enter a question" required>
            <div class="invalid-feedback">
              Please choose a username.
            </div>
          </div>
        </div>

        <div class="col-12">
          <button class="btn btn-primary" type="submit">Submit form</button>
        </div>
      </form>

    */

    function delAQn(BTN_ID) {
        post_obj.num_of_questions -= 1;
        num_of_qns -= 1;
        var btn_id_ls = BTN_ID.split("-");
        var QID = btn_id_ls[0].slice(1);
        console.log("===== clicked on delAQn() =====")
        console.log(`BTN_ID: ${BTN_ID} || NUM_OF_QNS: ${num_of_qns} || ${btn_id_ls} || ${QID}`);
        
        
        document.getElementById(`q${QID}`).remove(); // delete div
        QID_LS = removeItemFromArray(QID_LS, `q${QID}`);

        console.log(QID_LS);

        changeQnNumber();
    }

    function setQnType(qn_id) { // q1-type, q2-type //q${QID}-type
        const qn_id_ls = qn_id.split("-");
        qn_num = qn_id.slice(0, 2);
        qn_type = document.getElementById(`${qn_id}`).value; // tf-selected, mcq-selected
        console.log(`qn type: ${qn_type}`);

        document.getElementById(`${qn_id_ls[0]}-options`).innerHTML = "";
        html_content = "";

        if(qn_type == 'tf-selected') {
            html_content = `
            <div class="form-group">
                <input class="form-group-input" type="radio" name="${qn_id_ls[0]}-options" id="true" value="True" checked>
                <label class="form-group-label" for="true">True</label>
            </div>
            <div class="form-group">
                <input class="form-group-input" type="radio" name="${qn_id_ls[0]}-options" id="false" value="False">
                <label class="form-group-label" for="false">False</label>
            </div>
            `;
            document.getElementById(`${qn_num}-mcq-num`).setAttribute('class', 'form-group col-md-3 d-none');
        } 
        else if(qn_type == 'mcq-selected') {
            html_content = `
            <div class="input-group mb-2">
                <div class="input-group-prepend">
                    <div class="input-group-text">
                    <input type="radio" id='${qn_id_ls[0]}-mcq-options[1]-radio' name="${qn_id_ls[0]}-mcq-options-radio"  placeholder="Input text" checked>
                    </div>
                </div>
                <input type="text" id='${qn_id_ls[0]}-mcq-options[1]' name="${qn_id_ls[0]}-mcq-options[1]" class="form-control" placeholder="Input text">
            </div>
            <div class="input-group mb-2">
                <div class="input-group-prepend">
                    <div class="input-group-text">
                    <input type="radio" id='${qn_id_ls[0]}-mcq-options[2]-radio' name="${qn_id_ls[0]}-mcq-options-radio" aria-label="Radio button for following text input">
                    </div>
                </div>
                <input type="text" id='${qn_id_ls[0]}-mcq-options[2]' name="${qn_id_ls[0]}-mcq-options[2]" class="form-control" placeholder="Input text">
            </div>
            `;
            document.getElementById(`${qn_num}-mcq-num`).setAttribute('class', 'form-group col-md-3');
        }

        document.getElementById(`${qn_num}-options`).innerHTML = html_content;
    }

    function updateInput(){
        // console.log(`document.getElementById(id).value: ${document.getElementById(id).value} || ${input_val}`)
        // document.getElementById(id).value = input_val;
    }

    function changeNumOfOptions(option_id) {
        qn_id = option_id.slice(0, 2);
        option_num = document.getElementById(`${qn_id}-mcq-num-input`).value; // tf-selected, mcq-selected
        console.log(option_num, 'hehe')
        
        html_content = "";

        for (let i = 1; i <= option_num; i++) { // need change qn_id
            html_content +=  `
            <div class="input-group mb-2">
                <div class="input-group-prepend">
                    <div class="input-group-text">
                    <input type="radio" id='${qn_id}-mcq-options[${i}]-radio' name="${qn_id}-mcq-options-radio" aria-label="Radio button for following text input">
                    </div>
                </div>
                <input type="text" id='${qn_id}-mcq-options[${i}]' name="${qn_id}-mcq-options[${i}]" class="form-control" placeholder="Input text">
            </div>
            `;
        }

        // console.log(html_content)
        document.getElementById(`${qn_num}-options`).innerHTML = html_content;


    }


    function setSelectedValue(BTN_ID) {
        console.log(BTN_ID);

        var btn_ele = document.getElementById(`${BTN_ID}`);
        var qn_type = btn_ele.options[btn_ele.selectedIndex].text;

        if (qn_type == 'mcq-selected') {
            btn_ele.remove(1);
            document.querySelector('option[value=" + value +"]').selected = true
        } else {
            btn_ele.remove(2);
        }

        
        console.log(qn_type, 'qn_type');
    }
    

    function updateQuizSummary() {
        document.getElementById('quiz-summary').innerHTML = "";
        var total_marks = 0;
        for (i = 0; i < QID_LS.length; i++) {
            each_mark = parseInt(document.getElementById(`${QID_LS[i]}-marks`).value);
            
            if (!Number.isNaN(each_mark)) {
                total_marks += each_mark;
            }
        }
        
        var html_content = `
        <p>Total Marks: ${total_marks}</p> 
        <p>Number of Questions: ${num_of_qns}</p>
        `;

        document.getElementById('quiz-summary').innerHTML = html_content;
        console.log('===== quiz summary =====');
        console.log(`total marks: ${total_marks}`)
    }

    // POST REQUEST
    function createQuiz() {
        post_obj = getFinalQunInput();
        var json_string = JSON.stringify(post_obj); // stringify json object into a string

        console.log('===== quiz values =====')
        console.log(post_obj);
        console.log('validation', validation, invalid_msg);

        /*
                if (validation === false) {
            document.getElementById("create-quiz-alert").innerHTML = `
            <br><div class="alert alert-danger fade show" role="alert">
            ${invalid_msg}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div><br>`;
        }
        */
        const form = document.getElementById("quiz-form");
        if (!form.checkValidity()) {
            return
        }
        
        // create POST HTTP request
        var request = new XMLHttpRequest();
                
        request.onreadystatechange = function () {

        var message = "";
        var html_content = "";

            if (this.readyState == 4 && this.status == 200) {

                message = JSON.parse(this.response).message;
                // console.log(message);
                var chap_name = quiz_type == 'chapter_quiz' ? `Chapter ${quiz_id_list[2].slice(-2, -1)} Quiz` : 'Final Quiz'
                html_content = `<br><div class="alert alert-success fade show" role="alert">
                                You have successfully created ${chap_name} for ${quiz_id_list[0]} Class ${quiz_id_list[1].slice(1)}
                                </div><br>`;
                document.getElementById("create-quiz-alert").innerHTML = html_content;
                //break
            } 
            else {
                // console.log(message);
                console.log("code: 500 - code is not 200 or 201")
                //break
            }
        
        }

        var url = createQuiz_POST_TNR;
        request.open("POST", url, true);
        request.setRequestHeader("Content-Type", "application/json");
        request.send(json_string);

        

        
        
        
    }

    function getFinalQunInput() {

        // timing: HH:MM
        hours = document.getElementById(`hour`).value;
        minutes = document.getElementById(`minute`).value;
        if (hours   < 10) {hours   = "0"+hours;}
        if (minutes < 10) {minutes = "0"+minutes;}
        post_obj.timing = `${hours}:${minutes}`;
        // console.log('post_obj.timing', post_obj.timing)


        // true, false  
        for (i = 0; i < QID_LS.length; i++) {
            // question
            post_obj.question_id.push(`Q${i+1}`);

            // question type
            type_ele = document.getElementById(`${QID_LS[i]}-type`)
            each_qn_type = type_ele.options[type_ele.selectedIndex].text;
            post_obj.question_type.push(each_qn_type);

            // options list
            if (each_qn_type == 'T/F') {
                // option list
                each_option_ls = 'True,False';

                // answer
                each_answer = document.querySelector(`input[name="${QID_LS[i]}-options"]:checked`).value;
            } else { 
                // option list
                each_option_ls = '';
                option_num = document.getElementById(`${QID_LS[i]}-mcq-num-input`).value;
                for (j=0;j<option_num;j++) { // get by element id
                    each_option_ls += document.getElementById(`${QID_LS[i]}-mcq-options[${j+1}]`).value;
                    if ((j+1) != option_num){each_option_ls += ',';}
                    selected_id = document.querySelector(`input[name="${QID_LS[i]}-mcq-options-radio"]:checked`).getAttribute('id'); //q1-mcq-options[2]-radio 
                    each_answer = document.getElementById(selected_id.slice(0, -6)).value;
                } 
                
            }
            post_obj.option.push(each_option_ls);
            post_obj.answer.push(each_answer);

            // question list
            each_qn = document.getElementById(`${QID_LS[i]}-qn`).value;
            post_obj.question.push(each_qn);

            // question mark
            each_mark = document.getElementById(`${QID_LS[i]}-marks`).value;
            post_obj.question_mark.push(each_mark);

            // marks
            post_obj.total_marks += parseInt(document.getElementById(`${QID_LS[i]}-marks`).value);
        }

        return post_obj
    }


    // HELPER FUNCTION
    function removeItemFromArray(array, n) {
        const newArray = [];
    
        for ( let i = 0; i < array.length; i++) {
            if(array[i] !== n) {
                newArray.push(array[i]);
            }
        }
        return newArray;
    }

    function changeQnNumber() {
        var qn_cnt = 1;

        for (let i=0; i < QID_LS.length; i++) {
            document.getElementById(`${QID_LS[i]}-title`).innerHTML = `Question ${qn_cnt}`;
            qn_cnt += 1;
        }
    }

  
    </script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
</body>
</html>